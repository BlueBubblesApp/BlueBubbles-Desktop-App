{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/main/main.ts","webpack:///./src/main/server/constants.ts","webpack:///./src/main/server/databases/chat/entity/Attachment.ts","webpack:///./src/main/server/databases/chat/entity/Chat.ts","webpack:///./src/main/server/databases/chat/entity/Handle.ts","webpack:///./src/main/server/databases/chat/entity/Message.ts","webpack:///./src/main/server/databases/chat/entity/index.ts","webpack:///./src/main/server/databases/chat/index.ts","webpack:///./src/main/server/databases/config/entity/Config.ts","webpack:///./src/main/server/databases/config/entity/index.ts","webpack:///./src/main/server/databases/config/index.ts","webpack:///./src/main/server/databases/transformers/BooleanTransformer.ts","webpack:///./src/main/server/databases/transformers/index.ts","webpack:///./src/main/server/fileSystem/index.ts","webpack:///./src/main/server/index.ts","webpack:///./src/main/server/services/index.ts","webpack:///./src/main/server/services/socket/index.ts","webpack:///external \"electron\"","webpack:///external \"fs\"","webpack:///external \"path\"","webpack:///external \"reflect-metadata\"","webpack:///external \"socket.io-client\"","webpack:///external \"typeorm\"","webpack:///external \"url\""],"names":["win","BlueBubbles","BackendServer","start","createWindow","BrowserWindow","width","height","minWidth","minHeight","transparent","frame","webPreferences","nodeIntegration","process","env","ELECTRON_DISABLE_SECURITY_WARNINGS","loadURL","webContents","once","openDevTools","on","send","window","ipcMain","handle","minimize","maximize","unmaximize","app","quit","exit","platform","DEFAULT_CONFIG_ITEMS","serverAddress","passphrase","lastFetch","Attachment","Entity","PrimaryGeneratedColumn","Column","ManyToMany","type","Message","onDelete","JoinTable","name","joinColumns","inverseJoinColumns","Chat","Unique","nullable","Handle","OneToMany","message","JoinColumn","referencedColumnName","default","transformer","BooleanTransformer","ManyToOne","ChatRepository","constructor","db","initialize","isDev","isConnected","connect","dbPath","getPath","createConnection","database","entities","synchronize","logging","getChats","repo","getRepository","find","relations","getMessages","chatGuid","offset","limit","after","before","withChats","withAttachments","withHandle","sort","where","statement","args","Date","query","createQueryBuilder","leftJoinAndSelect","innerJoinAndSelect","andWhere","guid","length","item","orderBy","getMany","createChatFromResponse","res","chat","chatIdentifier","displayName","isArchived","style","messages","map","msg","createMessageFromResponse","participants","createHandleFromResponse","address","country","uncanonicalizedId","chats","handleId","text","subject","error","dateCreated","dateRead","associatedMessageGuid","dateDelivered","isFromMe","isDelayed","isAutoReply","isSystemMessage","isServiceMessage","isForward","cacheRoomnames","isAudioMessage","datePlayed","itemType","groupTitle","groupActionType","isExpired","associatedMessageType","expressiveSendStyleId","timeExpressiveSendStyleId","hasAttachments","Object","keys","includes","attachments","saveChat","existing","ROWID","findOne","update","save","saveHandle","savedChat","theHandle","i","relation","of","add","saveMessage","theMessage","saveAttachment","attachment","savedMessage","theAttachment","Config","PrimaryColumn","ConfigRepository","config","loadConfig","items","convertFromDbValue","value","contains","get","set","saniVal","convertToDbValue","cfg","create","input","Boolean","Number","test","String","getTime","from","dbValue","to","entityValue","FileSystem","attachmentsDir","setup","setupDirectories","fs","chatRepo","configRepo","socketService","setupComplete","servicesStarted","console","log","setupServices","ex","startIpcListeners","fetchChats","initializeDatabases","setupDefaults","key","override","SocketService","socketServer","connected","warn","emitData","loading","syncProgress","loginIsValid","loadingMessage","redirect","now","toLocaleString","hour","minute","hour12","emitToUI","count","chatObj","participant","payload","withBlurhash","getChatMessages","Math","ceil","later","_","__","event","errData","enteredServerAddress","enteredPassword","Promise","resolve","setTimeout","data","firstConnect","reject","io","Error","disconnect","withParticipants","emit","status","identifier"],"mappings":"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ACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA,I;;;;;;;;;;;AC3TA,qC;;;;;;;;;;;ACAA,+B;;;;;;;;;;;ACAA,iC;;;;;;;;;;;ACAA,6C;;;;;;;;;;;ACAA,6C;;;;;;;;;;;ACAA,oC;;;;;;;;;;;ACAA,gC","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/main/main.ts\");\n","import \"reflect-metadata\";\r\nimport { app, BrowserWindow, ipcMain } from \"electron\";\r\nimport * as path from \"path\";\r\nimport * as url from \"url\";\r\n\r\nimport { BackendServer } from \"@server/index\";\r\n\r\nlet win: BrowserWindow | null;\r\nconst BlueBubbles = new BackendServer(win);\r\nBlueBubbles.start();\r\n\r\nconst createWindow = async () => {\r\n    win = new BrowserWindow({\r\n        width: 1200,\r\n        height: 750,\r\n        minWidth: 550,\r\n        minHeight: 350,\r\n        transparent: true,\r\n        frame: false,\r\n        webPreferences: { nodeIntegration: true }\r\n    });\r\n\r\n    if (process.env.NODE_ENV !== \"production\") {\r\n        process.env.ELECTRON_DISABLE_SECURITY_WARNINGS = \"1\"; // eslint-disable-line require-atomic-updates\r\n        win.loadURL(`http://localhost:2004`);\r\n    } else {\r\n        win.loadURL(\r\n            url.format({\r\n                pathname: path.join(__dirname, \"index.html\"),\r\n                protocol: \"file:\",\r\n                slashes: true\r\n            })\r\n        );\r\n    }\r\n\r\n    if (process.env.NODE_ENV !== \"production\") {\r\n        // Open DevTools, see https://github.com/electron/electron/issues/12438 for why we wait for dom-ready\r\n        win.webContents.once(\"dom-ready\", () => {\r\n            win!.webContents.openDevTools();\r\n        });\r\n    }\r\n\r\n    win.on(\"closed\", () => {\r\n        win = null;\r\n    });\r\n\r\n    win.on(\"maximize\", () => {\r\n        if (win && win.webContents) win.webContents.send(\"maximized\");\r\n    });\r\n\r\n    win.on(\"unmaximize\", () => {\r\n        if (win && win.webContents) win.webContents.send(\"unmaximized\");\r\n    });\r\n\r\n    BlueBubbles.window = win;\r\n};\r\n\r\nipcMain.handle(\"minimize-event\", () => {\r\n    if (win && win.webContents) win.minimize();\r\n});\r\n\r\nipcMain.handle(\"maximize-event\", () => {\r\n    if (win && win.webContents) win.maximize();\r\n});\r\n\r\nipcMain.handle(\"unmaximize-event\", () => {\r\n    if (win && win.webContents) win.unmaximize();\r\n});\r\n\r\nipcMain.handle(\"close-event\", () => {\r\n    app.quit();\r\n    app.exit(0);\r\n});\r\n\r\napp.on(\"browser-window-focus\", () => {\r\n    if (win && win.webContents) win.webContents.send(\"focused\");\r\n});\r\n\r\napp.on(\"browser-window-blur\", () => {\r\n    if (win && win.webContents) win.webContents.send(\"blurred\");\r\n});\r\n\r\napp.on(\"ready\", createWindow);\r\n\r\napp.on(\"window-all-closed\", () => {\r\n    if (process.platform !== \"darwin\") {\r\n        app.quit();\r\n    }\r\n});\r\n\r\napp.on(\"activate\", () => {\r\n    if (win === null) {\r\n        createWindow();\r\n    }\r\n});\r\n","export const DEFAULT_CONFIG_ITEMS: { [key: string]: Function } = {\r\n    serverAddress: () => \"\",\r\n    passphrase: () => \"\",\r\n    lastFetch: () => 0\r\n};\r\n","import { Entity, PrimaryGeneratedColumn, Column, ManyToMany, JoinTable } from \"typeorm\";\r\nimport { Message } from \"@server/databases/chat/entity\";\r\n\r\n@Entity()\r\nexport class Attachment {\r\n    @PrimaryGeneratedColumn()\r\n    ROWID: number;\r\n\r\n    @Column(\"text\")\r\n    guid: string;\r\n\r\n    @Column(\"text\")\r\n    uti: string;\r\n\r\n    @Column(\"text\")\r\n    mimeType: string;\r\n\r\n    @Column(\"integer\")\r\n    transferState: number;\r\n\r\n    @Column(\"integer\")\r\n    isOutgoing: number;\r\n\r\n    @Column(\"integer\")\r\n    transferName: number;\r\n\r\n    @Column(\"integer\")\r\n    totalBytes: number;\r\n\r\n    @Column(\"integer\")\r\n    isSticker: number;\r\n\r\n    @Column(\"integer\")\r\n    hideAttachment: number;\r\n\r\n    @Column(\"text\")\r\n    blurhash: string;\r\n\r\n    @Column(\"integer\")\r\n    height: number;\r\n\r\n    @Column(\"integer\")\r\n    width: number;\r\n\r\n    @ManyToMany(type => Message, { onDelete: \"CASCADE\" })\r\n    @JoinTable({\r\n        name: \"attachment_message_join\",\r\n        joinColumns: [{ name: \"attachmentId\" }],\r\n        inverseJoinColumns: [{ name: \"messageId\" }]\r\n    })\r\n    messages: Message[];\r\n}\r\n","import { Unique, Entity, PrimaryGeneratedColumn, Column, ManyToMany, JoinTable } from \"typeorm\";\r\nimport { Handle, Message } from \"@server/databases/chat/entity\";\r\n\r\n@Entity()\r\n@Unique([\"guid\"])\r\nexport class Chat {\r\n    @PrimaryGeneratedColumn()\r\n    ROWID: number;\r\n\r\n    @Column(\"text\")\r\n    guid: string;\r\n\r\n    @Column(\"integer\")\r\n    style: number;\r\n\r\n    @Column(\"text\")\r\n    chatIdentifier: string;\r\n\r\n    @Column(\"integer\")\r\n    isArchived: number;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    displayName: string;\r\n\r\n    @ManyToMany(type => Handle, { onDelete: \"CASCADE\" })\r\n    @JoinTable({\r\n        name: \"chat_handle_join\",\r\n        joinColumns: [{ name: \"chatId\" }],\r\n        inverseJoinColumns: [{ name: \"handleId\" }]\r\n    })\r\n    participants: Handle[];\r\n\r\n    @ManyToMany(type => Message, { onDelete: \"CASCADE\" })\r\n    @JoinTable({\r\n        name: \"chat_message_join\",\r\n        joinColumns: [{ name: \"chatId\" }],\r\n        inverseJoinColumns: [{ name: \"messageId\" }]\r\n    })\r\n    messages: Message[];\r\n}\r\n","import { Entity, PrimaryGeneratedColumn, Column, OneToMany, JoinColumn, JoinTable, ManyToMany, Unique } from \"typeorm\";\r\nimport { Chat, Message } from \"@server/databases/chat/entity\";\r\n\r\n@Entity()\r\n@Unique([\"address\"])\r\nexport class Handle {\r\n    @PrimaryGeneratedColumn()\r\n    ROWID: number;\r\n\r\n    @Column(\"text\")\r\n    address: string;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    country: string;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    uncanonicalizedId: string;\r\n\r\n    @OneToMany(\r\n        type => Message,\r\n        message => message.handle\r\n    )\r\n    @JoinColumn({ name: \"ROWID\", referencedColumnName: \"handleId\" })\r\n    messages: Message[];\r\n\r\n    @ManyToMany(type => Chat, { onDelete: \"CASCADE\" })\r\n    @JoinTable({\r\n        name: \"chat_handle_join\",\r\n        joinColumns: [{ name: \"handleId\" }],\r\n        inverseJoinColumns: [{ name: \"chatId\" }]\r\n    })\r\n    chats: Chat[];\r\n}\r\n","import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinTable, JoinColumn, ManyToMany } from \"typeorm\";\r\nimport { Handle, Chat, Attachment } from \"@server/databases/chat/entity/\";\r\nimport { BooleanTransformer } from \"@server/databases/transformers\";\r\n\r\n@Entity()\r\nexport class Message {\r\n    @PrimaryGeneratedColumn()\r\n    ROWID: number;\r\n\r\n    @Column({ type: \"integer\", nullable: true })\r\n    handleId: number;\r\n\r\n    @Column(\"text\")\r\n    guid: string;\r\n\r\n    @Column(\"text\")\r\n    text: string;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    subject: string;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    country: string;\r\n\r\n    @Column(\"integer\")\r\n    error: number;\r\n\r\n    @Column({ type: \"integer\", nullable: false })\r\n    dateCreated: number;\r\n\r\n    @Column({ type: \"integer\", nullable: false, default: 0 })\r\n    dateRead: number;\r\n\r\n    @Column({ type: \"integer\", nullable: false, default: 0 })\r\n    dateDelivered: number;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer })\r\n    isFromMe: boolean;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer })\r\n    isDelayed: boolean;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer })\r\n    isAutoReply: boolean;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer })\r\n    isSystemMessage: boolean;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer })\r\n    isServiceMessage: boolean;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer })\r\n    isForward: boolean;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer })\r\n    isArchived: boolean;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    cacheRoomnames: string;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer, default: false })\r\n    isAudioMessage: boolean;\r\n\r\n    @Column(\"integer\")\r\n    datePlayed: number;\r\n\r\n    @Column(\"integer\")\r\n    itemType: number;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    groupTitle: string;\r\n\r\n    @Column(\"integer\")\r\n    groupActionType: number;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer, default: false })\r\n    isExpired: boolean;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    associatedMessageGuid: string;\r\n\r\n    @Column({ type: \"text\", nullable: false, default: 0 })\r\n    associatedMessageType: number;\r\n\r\n    @Column({ type: \"text\", nullable: true })\r\n    expressiveSendStyleId: string;\r\n\r\n    @Column({ type: \"integer\", nullable: false, default: 0 })\r\n    timeExpressiveSendStyleId: number;\r\n\r\n    @Column({ type: \"integer\", transformer: BooleanTransformer, default: false })\r\n    hasAttachments: boolean;\r\n\r\n    @ManyToOne(type => Handle)\r\n    @JoinColumn({ name: \"handleId\", referencedColumnName: \"ROWID\" })\r\n    handle: Handle | null;\r\n\r\n    @ManyToMany(type => Chat, { onDelete: \"CASCADE\" })\r\n    @JoinTable({\r\n        name: \"chat_message_join\",\r\n        joinColumns: [{ name: \"messageId\" }],\r\n        inverseJoinColumns: [{ name: \"chatId\" }]\r\n    })\r\n    chats: Chat[];\r\n\r\n    @ManyToMany(type => Attachment, { onDelete: \"CASCADE\" })\r\n    @JoinTable({\r\n        name: \"attachment_message_join\",\r\n        joinColumns: [{ name: \"messageId\" }],\r\n        inverseJoinColumns: [{ name: \"attachmentId\" }]\r\n    })\r\n    attachments: Attachment[];\r\n}\r\n","import { Attachment } from \"./Attachment\";\r\nimport { Chat } from \"./Chat\";\r\nimport { Handle } from \"./Handle\";\r\nimport { Message } from \"./Message\";\r\n\r\nexport { Attachment, Chat, Handle, Message };\r\n","import { app } from \"electron\";\r\nimport { createConnection, Connection } from \"typeorm\";\r\nimport { ChatResponse, HandleResponse, MessageResponse } from \"@server/types\";\r\n\r\nimport { Attachment, Chat, Handle, Message } from \"./entity\";\r\nimport { GetMessagesParams } from \"./types\";\r\n\r\nexport class ChatRepository {\r\n    db: Connection = null;\r\n\r\n    constructor() {\r\n        this.db = null;\r\n    }\r\n\r\n    async initialize(): Promise<Connection> {\r\n        const isDev = process.env.NODE_ENV !== \"production\";\r\n        if (this.db) {\r\n            if (!this.db.isConnected) await this.db.connect();\r\n            return this.db;\r\n        }\r\n\r\n        let dbPath = `${app.getPath(\"userData\")}/chat.db`;\r\n        if (!isDev) {\r\n            dbPath = `${app.getPath(\"userData\")}/BlueBubbles-Desktop-App/chat.db`;\r\n        }\r\n\r\n        this.db = await createConnection({\r\n            name: \"chat\",\r\n            type: \"sqlite\",\r\n            database: dbPath,\r\n            entities: [Attachment, Chat, Handle, Message],\r\n            synchronize: isDev,\r\n            logging: false\r\n        });\r\n\r\n        // Create the tables\r\n        if (!isDev) await this.db.synchronize();\r\n\r\n        return this.db;\r\n    }\r\n\r\n    async getChats() {\r\n        const repo = this.db.getRepository(Chat);\r\n        return repo.find({ relations: [\"participants\"] });\r\n    }\r\n\r\n    async getMessages({\r\n        chatGuid = null,\r\n        offset = 0,\r\n        limit = 100,\r\n        after = null,\r\n        before = null,\r\n        withChats = false,\r\n        withAttachments = true,\r\n        withHandle = true,\r\n        sort = \"DESC\",\r\n        where = [\r\n            {\r\n                statement: \"message.text IS NOT NULL\",\r\n                args: null\r\n            }\r\n        ]\r\n    }: GetMessagesParams) {\r\n        // Sanitize some params\r\n        // eslint-disable-next-line no-param-reassign\r\n        if (after && typeof after === \"number\") after = new Date(after);\r\n        // eslint-disable-next-line no-param-reassign\r\n        if (before && typeof before === \"number\") before = new Date(before);\r\n\r\n        // Get messages with sender and the chat it's from\r\n        const query = this.db.getRepository(Message).createQueryBuilder(\"message\");\r\n\r\n        if (withHandle) query.leftJoinAndSelect(\"message.handle\", \"handle\");\r\n\r\n        if (withAttachments)\r\n            query.leftJoinAndSelect(\r\n                \"message.attachments\",\r\n                \"attachment\",\r\n                \"message.ROWID = message_attachment.messageId AND \" +\r\n                    \"attachment.ROWID = message_attachment.attachmentId\"\r\n            );\r\n\r\n        // Inner-join because all messages will have a chat\r\n        if (chatGuid) {\r\n            query\r\n                .innerJoinAndSelect(\r\n                    \"message.chats\",\r\n                    \"chat\",\r\n                    \"message.ROWID = message_chat.messageId AND chat.ROWID = message_chat.chatId\"\r\n                )\r\n                .andWhere(\"chat.guid = :guid\", { guid: chatGuid });\r\n        } else if (withChats) {\r\n            query.innerJoinAndSelect(\r\n                \"message.chats\",\r\n                \"chat\",\r\n                \"message.ROWID = message_chat.messageId AND chat.ROWID = message_chat.chatId\"\r\n            );\r\n        }\r\n\r\n        // Add date restraints\r\n        if (after)\r\n            query.andWhere(\"message.dateCreated >= :after\", {\r\n                after: after as Date\r\n            });\r\n        if (before)\r\n            query.andWhere(\"message.dateCreated < :before\", {\r\n                before: before as Date\r\n            });\r\n\r\n        if (where && where.length > 0) for (const item of where) query.andWhere(item.statement, item.args);\r\n\r\n        // Add pagination params\r\n        query.orderBy(\"message.dateCreated\", sort);\r\n        query.offset(offset);\r\n        query.limit(limit);\r\n\r\n        return query.getMany();\r\n    }\r\n\r\n    static createChatFromResponse(res: ChatResponse): Chat {\r\n        const chat = new Chat();\r\n        chat.guid = res.guid;\r\n        chat.chatIdentifier = res.chatIdentifier;\r\n        chat.displayName = res.displayName;\r\n        chat.isArchived = res.isArchived ? 1 : 0;\r\n        chat.style = res.style;\r\n        chat.messages = (res.messages ?? []).map(msg => ChatRepository.createMessageFromResponse(msg));\r\n        chat.participants = (res.participants ?? []).map(handle => ChatRepository.createHandleFromResponse(handle));\r\n        return chat;\r\n    }\r\n\r\n    static createHandleFromResponse(res: HandleResponse): Handle {\r\n        const handle = new Handle();\r\n        handle.address = res.address;\r\n        handle.country = res.country;\r\n        handle.uncanonicalizedId = res.uncanonicalizedId;\r\n        handle.chats = (res.chats ?? []).map(chat => ChatRepository.createChatFromResponse(chat));\r\n        handle.messages = (res.messages ?? []).map(msg => ChatRepository.createMessageFromResponse(msg));\r\n        return handle;\r\n    }\r\n\r\n    static createMessageFromResponse(res: MessageResponse): Message {\r\n        const message = new Message();\r\n        message.handleId = res.handleId || res.handleId === 0 ? null : res.handleId;\r\n        message.guid = res.guid;\r\n        message.text = res.text;\r\n        message.subject = res.subject;\r\n        message.country = res.country;\r\n        message.error = res.error;\r\n        message.dateCreated = res.dateCreated ?? 0;\r\n        message.dateRead = res.dateRead ?? 0;\r\n        message.associatedMessageGuid = res.associatedMessageGuid;\r\n        message.dateDelivered = res.dateDelivered ?? 0;\r\n        message.isFromMe = res.isFromMe;\r\n        message.isDelayed = res.isDelayed;\r\n        message.isAutoReply = res.isAutoReply;\r\n        message.isSystemMessage = res.isSystemMessage;\r\n        message.isServiceMessage = res.isServiceMessage;\r\n        message.isForward = res.isForward;\r\n        message.isArchived = res.isArchived;\r\n        message.cacheRoomnames = res.cacheRoomnames;\r\n        message.isAudioMessage = res.isAudioMessage;\r\n        message.datePlayed = res.datePlayed ?? 0;\r\n        message.itemType = res.itemType;\r\n        message.groupTitle = res.groupTitle;\r\n        message.groupActionType = res.groupActionType;\r\n        message.isExpired = res.isExpired;\r\n        message.associatedMessageGuid = res.associatedMessageGuid;\r\n        message.associatedMessageType = res.associatedMessageType ?? 0;\r\n        message.expressiveSendStyleId = res.expressiveSendStyleId;\r\n        message.timeExpressiveSendStyleId = res.timeExpressiveSendStyleId ?? 0;\r\n        message.hasAttachments = Object.keys(res).includes(\"attachments\") && res.attachments.length > 0;\r\n        message.chats = (res.chats ?? []).map(chat => ChatRepository.createChatFromResponse(chat));\r\n        message.handle = res.handle ? ChatRepository.createHandleFromResponse(res.handle) : null;\r\n        return message;\r\n    }\r\n\r\n    async saveChat(chat: Chat): Promise<Chat> {\r\n        const repo = this.db.getRepository(Chat);\r\n        const existing = chat.ROWID ? chat : await repo.findOne({ guid: chat.guid });\r\n        if (existing) {\r\n            if (existing.displayName !== chat.displayName) {\r\n                // Right now, I don't think anything but the displayName will change\r\n                await repo.update(existing, { displayName: chat.displayName });\r\n            }\r\n\r\n            return existing;\r\n        }\r\n\r\n        // If it doesn't exist, create it\r\n        return repo.save(chat);\r\n    }\r\n\r\n    async saveHandle(chat: Chat, handle: Handle): Promise<Handle> {\r\n        // Always save the chat first\r\n        const savedChat = await this.saveChat(chat);\r\n        const repo = this.db.getRepository(Handle);\r\n        let theHandle: Handle = null;\r\n\r\n        // If the handle doesn't have a ROWID, try to find it\r\n        if (!handle.ROWID) {\r\n            theHandle = await repo.findOne({ address: handle.address }, { relations: [\"chats\"] });\r\n        }\r\n\r\n        // If the handle wasn't found, set it to the input handle\r\n        if (!theHandle && !handle.ROWID) {\r\n            theHandle = await repo.save(handle);\r\n        }\r\n\r\n        // Add the handle to the chat if it doesn't already exist\r\n        if (!theHandle.chats.find(i => i.ROWID === savedChat.ROWID)) {\r\n            await repo\r\n                .createQueryBuilder()\r\n                .relation(Handle, \"chats\")\r\n                .of(theHandle)\r\n                .add(savedChat);\r\n        }\r\n\r\n        return theHandle;\r\n    }\r\n\r\n    async saveMessage(chat: Chat, message: Message): Promise<Message> {\r\n        // Always save the chat first\r\n        const savedChat = await this.saveChat(chat);\r\n        const repo = this.db.getRepository(Message);\r\n        let theMessage = null;\r\n\r\n        // If the message doesn't have a ROWID, try to find it\r\n        if (!message.ROWID) {\r\n            theMessage = await repo.findOne({ guid: message.guid });\r\n        }\r\n\r\n        // If it exists, check if anything has really changed before updating\r\n        if (theMessage) {\r\n            if (\r\n                theMessage.dateDelivered !== message.dateDelivered ||\r\n                theMessage.dateRead !== message.dateRead ||\r\n                theMessage.error !== message.error ||\r\n                theMessage.isArchived !== message.isArchived ||\r\n                theMessage.datePlayed !== message.datePlayed\r\n            ) {\r\n                await repo.update(theMessage, {\r\n                    dateDelivered: message.datePlayed,\r\n                    dateRead: message.dateRead,\r\n                    error: message.error,\r\n                    isArchived: message.isArchived,\r\n                    datePlayed: message.datePlayed\r\n                });\r\n            }\r\n\r\n            return theMessage;\r\n        }\r\n\r\n        // Add handle to the message\r\n        if (message.handle) {\r\n            // eslint-disable-next-line no-param-reassign\r\n            message.handle = await this.saveHandle(chat, message.handle);\r\n        }\r\n\r\n        // If the message wasn't found, set it to the input message\r\n        theMessage = await repo.save(message);\r\n\r\n        // Add the message to the chat if it doesn't already exist\r\n        if (!theMessage.chats.find(i => i.ROWID === savedChat.ROWID)) {\r\n            await repo\r\n                .createQueryBuilder()\r\n                .relation(Message, \"chats\")\r\n                .of(theMessage)\r\n                .add(savedChat);\r\n        }\r\n\r\n        return theMessage;\r\n    }\r\n\r\n    async saveAttachment(chat: Chat, message: Message, attachment: Attachment): Promise<Attachment> {\r\n        // Always save the chat first\r\n        const savedChat = await this.saveChat(chat);\r\n        const savedMessage = await this.saveMessage(savedChat, message);\r\n        const repo = this.db.getRepository(Attachment);\r\n        let theAttachment = null;\r\n\r\n        // If the attachment doesn't have a ROWID, try to find it\r\n        if (!attachment.ROWID) {\r\n            theAttachment = await repo.findOne({ guid: attachment.guid }, { relations: [\"messages\"] });\r\n        }\r\n\r\n        // If the message wasn't found, set it to the input message\r\n        if (!theAttachment) theAttachment = await repo.save(attachment);\r\n\r\n        // Add the message to the chat if it doesn't already exist\r\n        if (!theAttachment.messages.find(i => i.ROWID === savedMessage.ROWID)) {\r\n            await repo\r\n                .createQueryBuilder()\r\n                .relation(Attachment, \"messages\")\r\n                .of(theAttachment)\r\n                .add(savedMessage);\r\n        }\r\n\r\n        return theAttachment;\r\n    }\r\n}\r\n","import { Entity, Column, PrimaryColumn } from \"typeorm\";\r\n\r\n@Entity()\r\nexport class Config {\r\n    @PrimaryColumn(\"text\", { name: \"name\" })\r\n    name: string;\r\n\r\n    @Column(\"text\", { name: \"value\", nullable: true })\r\n    value: string;\r\n}\r\n","import { Config } from \"./Config\";\r\n\r\nexport { Config };\r\n","import { app } from \"electron\";\r\nimport { createConnection, Connection, Long } from \"typeorm\";\r\n\r\nimport { Config } from \"./entity\";\r\n\r\nexport class ConfigRepository {\r\n    db: Connection = null;\r\n\r\n    config: { [key: string]: any };\r\n\r\n    constructor() {\r\n        this.db = null;\r\n        this.config = {};\r\n    }\r\n\r\n    async initialize(): Promise<Connection> {\r\n        const isDev = process.env.NODE_ENV !== \"production\";\r\n        if (this.db) {\r\n            if (!this.db.isConnected) await this.db.connect();\r\n            return this.db;\r\n        }\r\n\r\n        let dbPath = `${app.getPath(\"userData\")}/config.db`;\r\n        if (isDev) {\r\n            dbPath = `${app.getPath(\"userData\")}/BlueBubbles-Desktop-App/config.db`;\r\n        }\r\n\r\n        this.db = await createConnection({\r\n            name: \"config\",\r\n            type: \"sqlite\",\r\n            database: dbPath,\r\n            entities: [Config],\r\n            synchronize: isDev,\r\n            logging: false\r\n        });\r\n\r\n        // Create the tables\r\n        if (!isDev) await this.db.synchronize();\r\n\r\n        // Load default config items\r\n        await this.loadConfig();\r\n        return this.db;\r\n    }\r\n\r\n    private async loadConfig() {\r\n        const repo = this.db.getRepository(Config);\r\n        const items: Config[] = await repo.find();\r\n        for (const i of items) this.config[i.name] = ConfigRepository.convertFromDbValue(i.value);\r\n    }\r\n\r\n    /**\r\n     * Checks if the config has an item\r\n     *\r\n     * @param name The name of the item to check for\r\n     */\r\n    contains(name: string): boolean {\r\n        return Object.keys(this.config).includes(name);\r\n    }\r\n\r\n    /**\r\n     * Retrieves a config item from the cache\r\n     *\r\n     * @param name The name of the config item\r\n     */\r\n    get(name: string): Date | string | boolean | number {\r\n        if (!Object.keys(this.config).includes(name)) return null;\r\n        return ConfigRepository.convertFromDbValue(this.config[name]);\r\n    }\r\n\r\n    /**\r\n     * Sets a config item in the database\r\n     *\r\n     * @param name The name of the config item\r\n     * @param value The value for the config item\r\n     */\r\n    async set(name: string, value: Date | string | boolean | number): Promise<void> {\r\n        const saniVal = ConfigRepository.convertToDbValue(value);\r\n        const repo = this.db.getRepository(Config);\r\n        const item = await repo.findOne({ name });\r\n\r\n        // Either change or create the new Config object\r\n        if (item) {\r\n            await repo.update(item, { value: saniVal });\r\n        } else {\r\n            const cfg = repo.create({ name, value: saniVal });\r\n            await repo.save(cfg);\r\n        }\r\n\r\n        this.config[name] = saniVal;\r\n    }\r\n\r\n    /**\r\n     * Converts a generic string value from the database\r\n     * to its' corresponding correct typed value\r\n     *\r\n     * @param input The value straight from the database\r\n     */\r\n    private static convertFromDbValue(input: string): any {\r\n        if (input === \"1\" || input === \"0\") return Boolean(Number(input));\r\n        if (/^-{0,1}\\d+$/.test(input)) return Number(input);\r\n        return input;\r\n    }\r\n\r\n    /**\r\n     * Converts a typed database value input to a string.\r\n     *\r\n     * @param input The typed database value\r\n     */\r\n    private static convertToDbValue(input: any): string {\r\n        if (typeof input === \"boolean\") return input ? \"1\" : \"0\";\r\n        if (input instanceof Date) return String(input.getTime());\r\n        return String(input);\r\n    }\r\n}\r\n","import { ValueTransformer } from \"typeorm\";\r\n\r\nexport const BooleanTransformer: ValueTransformer = {\r\n    from: dbValue => Boolean(dbValue),\r\n    to: entityValue => Number(entityValue)\r\n};\r\n","import { BooleanTransformer } from \"./BooleanTransformer\";\r\n\r\nexport { BooleanTransformer };\r\n","import * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport { app } from \"electron\";\r\n\r\nexport class FileSystem {\r\n    public attachmentsDir = `Attachments`;\r\n\r\n    async setup(): Promise<void> {\r\n        this.setupDirectories();\r\n    }\r\n\r\n    // Creates required directories\r\n    setupDirectories(): void {\r\n        if (!fs.existsSync(this.attachmentsDir)) fs.mkdirSync(this.attachmentsDir);\r\n    }\r\n}\r\n","import { ipcMain, BrowserWindow } from \"electron\";\r\nimport { Connection } from \"typeorm\";\r\n\r\n// Config and FileSystem Imports\r\nimport { Config } from \"@server/databases/config/entity/Config\";\r\nimport { FileSystem } from \"@server/fileSystem\";\r\nimport { DEFAULT_CONFIG_ITEMS } from \"@server/constants\";\r\n\r\n// Database Imports\r\nimport { ConfigRepository } from \"@server/databases/config\";\r\nimport { ChatRepository } from \"@server/databases/chat\";\r\n\r\n// Service Imports\r\nimport { SocketService } from \"@server/services\";\r\n\r\nimport { ResponseFormat, ChatResponse, MessageResponse } from \"./types\";\r\nimport { GetChatMessagesParams } from \"./services/socket/types\";\r\n\r\nexport class BackendServer {\r\n    window: BrowserWindow;\r\n\r\n    db: Connection;\r\n\r\n    chatRepo: ChatRepository;\r\n\r\n    configRepo: ConfigRepository;\r\n\r\n    socketService: SocketService;\r\n\r\n    fs: FileSystem;\r\n\r\n    setupComplete: boolean;\r\n\r\n    servicesStarted: boolean;\r\n\r\n    constructor(window: BrowserWindow) {\r\n        this.window = window;\r\n\r\n        // Databases\r\n        this.chatRepo = null;\r\n        this.configRepo = null;\r\n\r\n        // Other helpers\r\n        this.fs = null;\r\n\r\n        // Services\r\n        this.socketService = null;\r\n\r\n        this.setupComplete = false;\r\n        this.servicesStarted = false;\r\n    }\r\n\r\n    /**\r\n     * Starts the back-end \"server\"\r\n     */\r\n    async start(): Promise<void> {\r\n        console.log(\"Starting BlueBubbles Backend...\");\r\n        await this.setup();\r\n\r\n        try {\r\n            console.log(\"Launching Services..\");\r\n            await this.setupServices();\r\n        } catch (ex) {\r\n            console.log(\"Failed to launch server services.\", \"error\");\r\n        }\r\n\r\n        console.log(\"Starting Configuration IPC Listeners...\");\r\n        this.startIpcListeners();\r\n\r\n        // Fetch the chats upon start\r\n        console.log(\"Syncing initial chats...\");\r\n        await this.fetchChats();\r\n    }\r\n\r\n    /**\r\n     * Sets up the server by initializing a \"filesystem\" and other\r\n     * tasks such as setting up the databases and internal services\r\n     */\r\n    private async setup(): Promise<void> {\r\n        console.log(\"Initializing database...\");\r\n        await this.initializeDatabases();\r\n\r\n        try {\r\n            console.log(\"Initializing filesystem...\");\r\n            this.fs = new FileSystem();\r\n            this.fs.setup();\r\n        } catch (ex) {\r\n            console.log(`!Failed to setup filesystem! ${ex.message}`);\r\n        }\r\n\r\n        this.setupComplete = true;\r\n    }\r\n\r\n    private async initializeDatabases() {\r\n        try {\r\n            console.log(\"Connecting to messaging database...\");\r\n            this.chatRepo = new ChatRepository();\r\n            await this.chatRepo.initialize();\r\n        } catch (ex) {\r\n            console.log(`Failed to connect to messaging database! ${ex.message}`);\r\n            console.log(ex);\r\n        }\r\n\r\n        try {\r\n            console.log(\"Connecting to settings database...\");\r\n            this.configRepo = new ConfigRepository();\r\n            await this.configRepo.initialize();\r\n        } catch (ex) {\r\n            console.log(`Failed to connect to settings database! ${ex.message}`);\r\n        }\r\n\r\n        await this.setupDefaults();\r\n    }\r\n\r\n    /**\r\n     * Sets up default database values for configuration items\r\n     */\r\n    private async setupDefaults(): Promise<void> {\r\n        try {\r\n            for (const key of Object.keys(DEFAULT_CONFIG_ITEMS)) {\r\n                if (!this.configRepo.contains(key)) {\r\n                    await this.configRepo.set(key, DEFAULT_CONFIG_ITEMS[key]());\r\n                }\r\n            }\r\n        } catch (ex) {\r\n            console.log(`Failed to setup default configurations! ${ex.message}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets up any internal services that need to be instantiated and configured\r\n     */\r\n    private async setupServices(override = false) {\r\n        if (this.servicesStarted && !override) return;\r\n\r\n        try {\r\n            console.log(\"Initializing up socket connection...\");\r\n            this.socketService = new SocketService(this.db, this.chatRepo, this.configRepo, this.fs);\r\n\r\n            // Start the socket service\r\n            await this.socketService.start();\r\n        } catch (ex) {\r\n            console.log(`Failed to setup socket service! ${ex.message}`);\r\n        }\r\n\r\n        this.servicesStarted = true;\r\n    }\r\n\r\n    /**\r\n     * Fetches chats from the server based on the last time we fetched data.\r\n     * This is what the server itself calls when it is refreshed or reloaded.\r\n     * The front-end _should not_ call this function.\r\n     */\r\n    async fetchChats(): Promise<void> {\r\n        if (!this.socketService?.socketServer?.connected) {\r\n            console.warn(\"Cannot fetch chats when no socket is connected!\");\r\n            return;\r\n        }\r\n\r\n        const emitData = {\r\n            loading: true,\r\n            syncProgress: 0,\r\n            loginIsValid: true,\r\n            loadingMessage: \"Connected to the server! Fetching chats...\",\r\n            redirect: null\r\n        };\r\n\r\n        const now = new Date();\r\n        const lastFetch = this.configRepo.get(\"lastFetch\") as number;\r\n        const chats: ChatResponse[] = await this.socketService.getChats({});\r\n\r\n        emitData.syncProgress = 1;\r\n        emitData.loadingMessage = `Got ${chats.length} chats from the server since last fetch at ${new Date(\r\n            lastFetch\r\n        ).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })}`;\r\n        console.log(emitData.loadingMessage);\r\n        this.emitToUI(\"setup-update\", emitData);\r\n\r\n        // Iterate over each chat and fetch their messages\r\n        let count = 1;\r\n        for (const chat of chats) {\r\n            // First, emit the chat to the front-end\r\n            this.emitToUI(\"chat\", chat);\r\n\r\n            // Second, save the chat to the database\r\n            const chatObj = ChatRepository.createChatFromResponse(chat);\r\n            const savedChat = await this.chatRepo.saveChat(chatObj);\r\n\r\n            // Third, save the participants for the chat\r\n            for (const participant of chat.participants ?? []) {\r\n                const handle = ChatRepository.createHandleFromResponse(participant);\r\n                await this.chatRepo.saveHandle(savedChat, handle);\r\n            }\r\n\r\n            // Build message request params\r\n            const payload: GetChatMessagesParams = { withChats: false, limit: 25, offset: 0, withBlurhash: true };\r\n            if (lastFetch) {\r\n                payload.after = lastFetch;\r\n                // Since we are fetching after a date, we want to get as much as we can\r\n                payload.limit = 1000;\r\n            }\r\n\r\n            // Third, let's fetch the messages from the DB\r\n            const messages: MessageResponse[] = await this.socketService.getChatMessages(chat.guid, payload);\r\n            emitData.loadingMessage = `Syncing ${messages.length} messages for ${count} of ${chats.length} chats`;\r\n            console.log(emitData.loadingMessage);\r\n\r\n            // Fourth, let's save the messages to the DB\r\n            for (const message of messages) {\r\n                const msg = ChatRepository.createMessageFromResponse(message);\r\n                await this.chatRepo.saveMessage(savedChat, msg);\r\n            }\r\n\r\n            // Lastly, save the attachments (if any)\r\n            // TODO\r\n\r\n            emitData.syncProgress = Math.ceil((count / chats.length) * 100);\r\n            if (emitData.syncProgress > 100) emitData.syncProgress = 100;\r\n            this.emitToUI(\"setup-update\", emitData);\r\n            count += 1;\r\n        }\r\n\r\n        // Tell the UI we are finished\r\n        const later = new Date();\r\n        emitData.redirect = \"/messaging\";\r\n        emitData.syncProgress = 100;\r\n        emitData.loadingMessage = `Finished fetching messages from socket server in [${later.getTime() -\r\n            now.getTime()} ms].`;\r\n        console.log(emitData.loadingMessage);\r\n        this.emitToUI(\"setup-update\", emitData);\r\n\r\n        // Save the last fetch date\r\n        this.configRepo.set(\"lastFetch\", now);\r\n    }\r\n\r\n    private startIpcListeners() {\r\n        // eslint-disable-next-line no-return-await\r\n        ipcMain.handle(\"get-config\", async (_, __) => await this.configRepo.config);\r\n\r\n        ipcMain.handle(\"set-config\", async (event, args) => {\r\n            console.log(args.constructor);\r\n            if (args.constructor !== Object) return this.configRepo.config;\r\n            for (const key of Object.keys(args)) {\r\n                await this.configRepo.set(key, args[key]);\r\n            }\r\n\r\n            this.emitToUI(\"config-update\", this.configRepo.config);\r\n            return this.configRepo.config;\r\n        });\r\n\r\n        ipcMain.handle(\"start-socket-setup\", async (_, args) => {\r\n            const errData = {\r\n                loading: true,\r\n                syncProgress: 0,\r\n                loginIsValid: false,\r\n                loadingMessage: \"Setup is starting...\"\r\n            };\r\n\r\n            // Make sure the config DB is setup\r\n            if (!this.configRepo || !this.configRepo.db.isConnected) {\r\n                errData.loadingMessage = \"Configuration DB is not yet setup!\";\r\n                return this.emitToUI(\"setup-update\", errData);\r\n            }\r\n\r\n            // Save the config items\r\n            await this.configRepo.set(\"serverAddress\", args.enteredServerAddress);\r\n            await this.configRepo.set(\"passphrase\", args.enteredPassword);\r\n\r\n            try {\r\n                // If we can't even connect, GTFO\r\n                await this.socketService.start(true);\r\n            } catch {\r\n                errData.loadingMessage = \"Could not connect to the server!\";\r\n                return this.emitToUI(\"setup-update\", errData);\r\n            }\r\n\r\n            // Wait 1 second to see if we got disconnected\r\n            await new Promise(resolve => setTimeout(resolve, 1000));\r\n\r\n            // Now check if we are disconnected. If creds are wrong, we will get disconnected here\r\n            if (!this.socketService.socketServer.connected) {\r\n                errData.loadingMessage = \"Disconnected from socket server! Credentials may be incorrect!\";\r\n                return this.emitToUI(\"setup-update\", errData);\r\n            }\r\n\r\n            // Start fetching the data\r\n            this.fetchChats();\r\n            return null; // Consistent return\r\n        });\r\n\r\n        // eslint-disable-next-line no-return-await\r\n        ipcMain.handle(\"get-chats\", async (_, __) => await this.chatRepo.getChats());\r\n\r\n        // eslint-disable-next-line no-return-await\r\n        ipcMain.handle(\"get-chat-messages\", async (_, args) => await this.chatRepo.getMessages(args));\r\n    }\r\n\r\n    private emitToUI(event: string, data: any) {\r\n        if (this.window) this.window.webContents.send(event, data);\r\n    }\r\n}\r\n","import { SocketService } from \"./socket\";\r\n\r\nexport { SocketService};","import * as io from \"socket.io-client\";\r\n\r\n// Internal Libraries\r\nimport { FileSystem } from \"@server/fileSystem\";\r\nimport { ResponseFormat, ChatResponse, MessageResponse } from \"@server/types\";\r\n\r\n// Database Dependency Imports\r\nimport { ConfigRepository } from \"@server/databases/config\";\r\nimport { ChatRepository } from \"@server/databases/chat\";\r\nimport { Connection } from \"typeorm\";\r\n\r\nimport { GetChatsParams, GetChatMessagesParams } from \"./types\";\r\n\r\nexport class SocketService {\r\n    db: Connection;\r\n\r\n    socketServer: SocketIOClient.Socket;\r\n\r\n    chatRepo: ChatRepository;\r\n\r\n    configRepo: ConfigRepository;\r\n\r\n    fs: FileSystem;\r\n\r\n    serverAddress: string;\r\n\r\n    passphrase: string;\r\n\r\n    /**\r\n     * Starts up the initial Socket.IO connection and initializes other\r\n     * required classes and variables\r\n     *\r\n     * @param chatRepo The iMessage database repository\r\n     * @param configRepo The app's settings repository\r\n     * @param fs The filesystem class handler\r\n     */\r\n    constructor(db: Connection, chatRepo: ChatRepository, configRepo: ConfigRepository, fs: FileSystem) {\r\n        this.db = db;\r\n\r\n        this.socketServer = null;\r\n        this.chatRepo = chatRepo;\r\n        this.configRepo = configRepo;\r\n        this.fs = fs;\r\n    }\r\n\r\n    /**\r\n     * Sets up the socket listeners\r\n     */\r\n    async start(firstConnect = false): Promise<boolean> {\r\n        if (!this.configRepo || !this.configRepo.get(\"serverAddress\") || !this.configRepo.get(\"passphrase\")) {\r\n            console.error(\"Setup has not been completed!\");\r\n            return false;\r\n        }\r\n\r\n        return new Promise((resolve, reject) => {\r\n            this.socketServer = io(this.configRepo.get(\"serverAddress\") as string, {\r\n                query: {\r\n                    guid: this.configRepo.get(\"passphrase\")\r\n                }\r\n            });\r\n\r\n            this.socketServer.on(\"connect\", () => {\r\n                console.log(\"Connected to server via socket.\");\r\n                resolve(true);\r\n            });\r\n\r\n            this.socketServer.on(\"disconnect\", () => {\r\n                console.log(\"Disconnected from socket server.\");\r\n                reject(new Error(\"Disconnected from socket.\"));\r\n            });\r\n\r\n            this.socketServer.on(\"connect_error\", () => {\r\n                console.log(\"Unable to connect to server.\");\r\n\r\n                // If this is the first/initial connect, disconnect if there is an error\r\n                if (firstConnect) this.socketServer.disconnect();\r\n                reject(new Error(\"Unable to connect to server.\"));\r\n            });\r\n        });\r\n    }\r\n\r\n    async getChats({ withParticipants = true }: GetChatsParams): Promise<ChatResponse[]> {\r\n        return new Promise<ChatResponse[]>((resolve, reject) => {\r\n            this.socketServer.emit(\"get-chats\", { withParticipants }, (res: ResponseFormat) => {\r\n                if ([200, 201].includes(res.status)) {\r\n                    resolve(res.data as ChatResponse[]);\r\n                } else {\r\n                    reject(res.message);\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    async getChatMessages(\r\n        identifier: string,\r\n        { offset = 0, limit = 25, after = null, before = null, withChats = false, sort = \"DESC\" }: GetChatMessagesParams\r\n    ): Promise<MessageResponse[]> {\r\n        return new Promise<MessageResponse[]>((resolve, reject) => {\r\n            this.socketServer.emit(\r\n                \"get-chat-messages\",\r\n                {\r\n                    identifier,\r\n                    offset,\r\n                    limit,\r\n                    after,\r\n                    before,\r\n                    withChats,\r\n                    sort\r\n                },\r\n                res => {\r\n                    if ([200, 201].includes(res.status)) {\r\n                        resolve(res.data as MessageResponse[]);\r\n                    } else {\r\n                        reject(res.message);\r\n                    }\r\n                }\r\n            );\r\n        });\r\n    }\r\n}\r\n\r\n// import {createConnection, getManager} from \"typeorm\";\r\n// import {Handle} from \"../entities/messaging/Handle\";\r\n// import {chatPrevGetAllAction} from \"../actions/ChatPrevGetAllAction\";\r\n\r\n// //Connect to server with socket\r\n// export async function ConnectToServer(url, aGuid){\r\n\r\n// }\r\n\r\n// createConnection({\r\n//     type: \"sqlite\",\r\n//     database: \"src/main/server/db/messaging.db\",\r\n//     entities: [\r\n//         Handle\r\n//     ],\r\n//     synchronize: true,\r\n//     logging: false\r\n// }).then(async connection => {\r\n//     const io = require('socket.io-client')\r\n//     const socket = io(\"\",{\r\n//     query: {\r\n//         guid: \"\"\r\n//     }\r\n//     })\r\n\r\n//     // On Socket Connect\r\n//     socket.on('connect', () => {\r\n//     console.log(socket.connected)\r\n//     const firstAppStartUp = true;\r\n\r\n//     if (firstAppStartUp){\r\n//         //Get all chats from server and save locally\r\n//         // initFromServer();\r\n//         GetAllChatsFromServer();\r\n//         console.log(\"here\");\r\n//     } else{\r\n\r\n//     }\r\n//     });\r\n\r\n//     // let handle = new Handle();\r\n//     // handle.address = \"\";\r\n\r\n//     //Get All Chats\r\n//     function GetAllChatsFromServer() {\r\n//         socket.emit('get-chats',true,(data) => {\r\n//         console.log(data.data[0].participants[0].address);\r\n//         await GetHandle();\r\n//         chatPrevGetAllAction();\r\n\r\n//         //Get Handle\r\n//         asyncfunction GetHandle() {\r\n//             let handleRepository = connection.getRepository(Handle);\r\n//             let i;\r\n//             for(i=0; i < Object.keys(data.data).length; i++){\r\n//                 let handle = new Handle();\r\n//                 if(data.data[i].participants[0].address != null) {\r\n//                     handle.address = data.data[i].participants[0].address;\r\n//                 };\r\n//                 if(data.data[i].participants[0].country != null) {\r\n//                     handle.country = data.data[i].participants[0].country;\r\n//                 };\r\n//                 if(data.data[i].participants[0].uncanonicalizedId != null) {\r\n//                     handle.uncanonicalizedId = data.data[i].participants[0].uncanonicalizedId;\r\n//                 } else{\r\n//                     handle.uncanonicalizedId = \"X:XX PM\";\r\n//                 };\r\n//                 // console.log(handle.address);\r\n//                 try {\r\n//                     // return connection.manager\r\n//                     //             .save(handle)\r\n//                     //             .then(handle => {\r\n//                     //                 console.log(\"handle has been saved. handle address is\", handle.address);\r\n//                     //             });\r\n//                     handleRepository.save(handle);\r\n//                     console.log(\"Handle saved\");\r\n//                 } catch (err){\r\n//                     console.log(err);\r\n//                 }\r\n\r\n//             }\r\n//         }\r\n\r\n//             return data\r\n//         })\r\n//     }\r\n\r\n// }).catch(error => console.log(\"TypeORM connection error: \", error));\r\n\r\n// // const initFromServer = {\r\n\r\n// // }\r\n\r\n// //Get A Single Chat by guid\r\n// function GetSingleChat(guid){\r\n//     socket.emit(\"get-chat\",{chatGuid: guid}, (data) =>{\r\n//         console.log(data.data)\r\n//         return data.data\r\n//     })\r\n// }\r\n\r\n// //Get All Messages In A Chat\r\n// function GetChatMessages(guid){\r\n//     socket.emit(\"get-chat-messages\",{identifier: guid}, (data) =>{\r\n//         console.log(data.data)\r\n//         return data.data\r\n//     })\r\n// }\r\n\r\n// //Get Most Recent Message For A Given guid\r\n// function GetMostRecentMessage(guid){\r\n//     socket.emit(\"get-last-chat-message\",{identifier: guid}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Get Attachment By guid\r\n// function GetAttachmentByGUID(guid){\r\n//     socket.emit(\"get-attatchment\",{identifier: guid}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Get Attachment Chunk By guid\r\n// function GetAttachmentChunkByGUID(guid){\r\n//     socket.emit(\"get-attatchment-chunk\",{identifier: guid}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Get Participants In A Chat\r\n// function GetChatParticipants(guid){\r\n//     socket.emit(\"get-participants\",{identifier: guid}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Send A Message\r\n// function SendMessage(chatGuid, myMessage) {\r\n//     socket.emit(\"send-message\",{guid: chatGuid, message: myMessage}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Send A Message With Chunked Attachments\r\n// function SendMessageWithAttachment(guid, myMessage,myAttachmentData){\r\n//     socket.emit(\"send-message-chunk\",{guid: guid, message: myMessage, attachmentData: myAttachmentData}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Start A Chat\r\n// function NewChat(guid, chatParticipants){\r\n//     socket.emit(\"start-chat\",{identifier: guid, participants: chatParticipants}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Rename A Group Chat\r\n// function RenameGroupChat(guid, newGroupName) {\r\n//     socket.emit(\"rename-group\",{identifier: guid, newName: newGroupName}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Add A Participant To Chat\r\n// function AddParticipantToChat(guid, participantAddress){\r\n//     socket.emit(\"add-participant\",{identifier: guid, address: participantAddress}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Remove A Participant To Chat\r\n// function RemoveParticipantToChat(guid, participantAddress){\r\n//     socket.emit(\"remove-participant\",{identifier: guid, address: participantAddress}, (data) =>{\r\n//         console.log(data)\r\n//         return data\r\n//     })\r\n// }\r\n\r\n// //Send Reaction (NOT IMPLEMENTED IN SERVER)\r\n// function SendReaction(guid) {\r\n//     socket.emit(\"send-reaction\",{identifier: guid}, (data) =>{\r\n//         console.log(data)\r\n//     })\r\n// }\r\n","module.exports = require(\"electron\");","module.exports = require(\"fs\");","module.exports = require(\"path\");","module.exports = require(\"reflect-metadata\");","module.exports = require(\"socket.io-client\");","module.exports = require(\"typeorm\");","module.exports = require(\"url\");"],"sourceRoot":""}